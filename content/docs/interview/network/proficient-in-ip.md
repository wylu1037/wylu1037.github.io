---
title: 精通 IP
date: 2024-03-14T09:13:24+08:00
authors:
  - name: wylu
    link: https://github.com/wylu1037
    image: https://github.com/wylu1037.png?size=40
weight: 4
---

## 1.IP 基本认识

## 2.IP 地址的基础认识

## 3.IP 协议相关技术

| 协议                    | 作用               |
| ----------------------- | ------------------ |
| DNS                     | 域名解析           |
| ARP 协议 与 RARP 服务器 |                    |
| DHCP                    | 动态获取 IP 地址   |
| NAT                     | 网络地址转换       |
| ICMP                    | 互联网控制报文协议 |
| IGMP                    | 因特网组管理协议   |

### 3.1 DNS

浏览器首先看一下自己的缓存里有没有，如果没有就向操作系统的缓存要，还没有就检查本机域名解析文件 hosts，如果还是没有，就会 DNS 服务器进行查询，查询的过程如下：

{{% steps %}}

<h5></h5>

客户端首先会发出一个 DNS 请求，问 www.server.com 的 IP 是啥，并发给本地 DNS 服务器（也就是客户端的 TCP/IP 设置中填写的 DNS 服务器地址）。

<h5></h5>

本地域名服务器收到客户端的请求后，如果缓存里的表格能找到 www.server.com，则它直接返回 IP 地址。如果没有，本地 DNS 会去问它的根域名服务器：“老大， 能告诉我 www.server.com 的 IP 地址吗？” 根域名服务器是最高层次的，它不直接用于域名解析，但能指明一条道路。

<h5></h5>

根 DNS 收到来自本地 DNS 的请求后，发现后置是 .com，说：“www.server.com 这个域名归 .com 区域管理”，我给你 .com 顶级域名服务器地址给你，你去问问它吧。”

<h5></h5>

本地 DNS 收到顶级域名服务器的地址后，发起请求问“老二， 你能告诉我 www.server.com 的 IP 地址吗？”

<h5></h5>

顶级域名服务器说：“我给你负责 www.server.com 区域的权威 DNS 服务器的地址，你去问它应该能问到”。

<h5></h5>

本地 DNS 于是转向问权威 DNS 服务器：“老三，www.server.com对应的IP是啥呀？” server.com 的权威 DNS 服务器，它是域名解析结果的原出处。为啥叫权威呢？就是我的域名我做主。

<h5></h5>

权威 DNS 服务器查询后将对应的 IP 地址 X.X.X.X 告诉本地 DNS。

<h5></h5>

本地 DNS 再将 IP 地址返回客户端，客户端和目标建立连接。
{{% /steps %}}

{{< image "/images/docs/interview/network/dns-lookup.webp" "DNS 解析" >}}

### 3.2 ARP

### 3.3 DHCP

电脑通常都是通过 DHCP 动态获取 IP 地址，大大省去了配 IP 信息繁琐的过程。

{{% steps %}}

<h5></h5>

客户端首先发起 DHCP 发现报文（DHCP DISCOVER） 的 IP 数据报，由于客户端没有 IP 地址，也不知道 DHCP 服务器的地址，所以使用的是 UDP 广播通信，其使用的广播目的地址是 255.255.255.255（端口 67） 并且使用 0.0.0.0（端口 68） 作为源 IP 地址。DHCP 客户端将该 IP 数据报传递给链路层，链路层然后将帧广播到所有的网络中设备。

<h5></h5>

DHCP 服务器收到 DHCP 发现报文时，用 DHCP 提供报文（DHCP OFFER） 向客户端做出响应。该报文仍然使用 IP 广播地址 255.255.255.255，该报文信息携带服务器提供可租约的 IP 地址、子网掩码、默认网关、DNS 服务器以及 IP 地址租用期。

<h5></h5>

客户端收到一个或多个服务器的 DHCP 提供报文后，从中选择一个服务器，并向选中的服务器发送 DHCP 请求报文（DHCP REQUEST 进行响应，回显配置的参数。

<h5></h5>

最后，服务端用 DHCP ACK 报文对 DHCP 请求报文进行响应，应答所要求的参数。
{{% /steps %}}

{{< callout >}}
说明一点，DHCP 客户端进程监听的是 68 端口号，DHCP 服务端进程监听的是 67 端口号。
{{< /callout >}}

{{% details title="查看图片" closed="true" %}}
{{< image "/images/docs/interview/network/DHCP步骤.webp" "DHCP步骤" >}}
{{% /details %}}

一旦客户端收到 DHCP ACK 后，交互便完成了，并且客户端能够在租用期内使用 DHCP 服务器分配的 IP 地址。如果租约的 DHCP IP 地址快期后，客户端会向服务器发送 DHCP 请求报文：

- 服务器如果同意继续租用，则用 DHCP ACK 报文进行应答，客户端就会延长租期。
- 服务器如果不同意继续租用，则用 DHCP NACK 报文，客户端就要停止使用租约的 IP 地址。

{{< callout >}}
DHCP 交互中，全程都是使用 UDP 广播通信。用的是**广播**，那如果 DHCP 服务器和客户端不是在同一个局域网内，路由器又不会转发广播包，那不是每个网络都要配一个 DHCP 服务器？
{{< /callout >}}
为了解决这一问题，就出现了 DHCP 中继代理。有了 DHCP 中继代理以后，对不同网段的 IP 地址分配也可以由一个 DHCP 服务器统一进行管理。

{{% details title="查看DHCP中继代理图" closed="true" %}}
{{< image "/images/docs/interview/network/DHCP中继代理.webp" "DHCP中继代理" >}}
{{% /details%}}

{{% steps %}}

<h5></h5>

DHCP 客户端会向 DHCP 中继代理发送 DHCP 请求包，而 DHCP 中继代理在收到这个广播包以后，再以单播的形式发给 DHCP 服务器。

<h5></h5>

服务器端收到该包以后再向 DHCP 中继代理返回应答，并由 DHCP 中继代理将此包广播给 DHCP 客户端 。
{{% /steps %}}

因此，DHCP 服务器即使不在同一个链路上也可以实现统一分配和管理 IP 地址。

### 3.4 NAT

为了缓解了 IPv4 地址耗尽的问题，提出了一种网络地址转换 NAT 的方法。简单的来说 NAT 就是同个公司、家庭、教室内的主机对外部通信时，把私有 IP 地址转换成公有 IP 地址。

{{< image "/images/docs/interview/network/NAT.webp" "NAT" >}}

> 那不是 N 个私有 IP 地址，你就要 N 个公有 IP 地址？这怎么就缓解了 IPv4 地址耗尽的问题？

普通的 NAT 转换没什么意义。由于绝大多数的网络应用都是使用传输层协议 TCP 或 UDP 来传输数据的，因此，可以把 `IP 地址` + `端口号` 一起进行转换。这样，就用一个全球 IP 地址就可以了，这种转换技术就叫 {{< font "blue" "网络地址与端口转换 NAPT" >}}。

{{< image "/images/docs/interview/network/NAPT.webp" "NAPT" >}}

图中有两个客户端 192.168.1.10 和 192.168.1.11 同时与服务器 183.232.231.172 进行通信，并且这两个客户端的本地端口都是 1025。此时，两个私有 IP 地址都转换 IP 地址为公有地址 120.229.175.121，但是以不同的端口号作为区分。

于是，生成一个 NAPT 路由器的转换表，就可以正确地转换地址跟端口的组合，令客户端 A、B 能同时与服务器之间进行通信。

这种转换表在 NAT 路由器上自动生成。例如，在 TCP 的情况下，建立 TCP 连接首次握手时的 SYN 包一经发出，就会生成这个表。而后又随着收到关闭连接时发出 FIN 包的确认应答从表中被删除。

{{< callout >}}

NAT 缺点，由于 NAT/NAPT 都依赖于自己的转换表，因此会有以下的问题：

- 外部无法主动与 NAT 内部服务器建立连接，因为 NAPT 转换表没有转换记录。
- 转换表的生成与转换操作都会产生性能开销。
- 通信过程中，如果 NAT 路由器重启了，所有的 TCP 连接都将被重置。

{{< /callout >}}

<br>
{{< font "blue" "解决的方法主要有两种方法" >}}

{{< tabs items="改用 IPv6,NAT 穿透技术">}}
{{< tab >}}
IPv6 可用范围非常大，以至于每台设备都可以配置一个公有 IP 地址，就不搞那么多花里胡哨的地址转换了，但是 IPv6 普及速度还需要一些时间。
{{< /tab >}}

{{< tab >}}
NAT 穿越技术拥有这样的功能，它能够让网络应用程序主动发现自己位于 NAT 设备之后，并且会主动获得 NAT 设备的公有 IP，并为自己建立端口映射条目，注意这些都是 NAT 设备后的应用程序自动完成的。

也就是说，在 NAT 穿透技术中，NAT 设备后的应用程序处于主动地位，它已经明确地知道 NAT 设备要修改它外发的数据包，于是它主动配合 NAT 设备的操作，主动地建立好映射，这样就不像以前由 NAT 设备来建立映射了。

直白点说，就是客户端主动从 NAT 设备获取公有 IP 地址，然后自己建立端口映射条目，然后用这个条目对外通信，就不需要 NAT 设备来进行转换了。
{{< /tab >}}
{{< /tabs >}}

### 3.5 ICMP

ICMP 全称是 Internet Control Message Protocol，也就是互联网控制报文协议。

ICMP 主要的功能包括：确认 IP 包**是否成功送达目标地址**、**报告发送过程中 IP 包被废弃的原因**和**改善网络设置**等。

在 IP 通信中如果某个 IP 包因为某种原因未能达到目标地址，那么这个具体的原因将由 ICMP 负责通知。
{{< image "/images/docs/interview/network/ICMP.webp" "ICMP" >}}

如上图例子，主机 A 向主机 B 发送了数据包，由于某种原因，途中的路由器 2 未能发现主机 B 的存在，这时，路由器 2 就会向主机 A 发送一个 ICMP 目标不可达数据包，说明发往主机 B 的包未能成功。

ICMP 的这种通知消息会使用 IP 进行发送。因此，从路由器 2 返回的 ICMP 包会按照往常的路由控制先经过路由器 1 再转发给主机 A 。收到该 ICMP 包的主机 A 则分解 ICMP 的首部和数据域以后得知具体发生问题的原因。

ICMP 大致可以分为两大类：

- 一类是用于诊断的查询消息，也就是 {{< font "orange" "查询报文类型" >}}；
- 另一类是通知出错原因的错误消息，也就是 {{< font "green" "差错报文类型" >}}；
  {{< image "/images/docs/interview/network/ICMP类型.webp" "ICMP类型" >}}

### 3.6 IGMP

在前面知道了组播地址，也就是 D 类地址，既然是组播，那就说明是只有一组的主机能收到数据包，不在一组的主机不能收到数组包，怎么管理是否是在一组呢？那么，就需要 IGMP（Internet Group Management Protocol） 协议了。
{{< image "/images/docs/interview/network/IGMP.webp" "IGMP" >}}
IGMP 是因特网组管理协议，工作在主机（组播成员）和最后一跳路由之间，如上图中的蓝色部分。

- IGMP 报文向路由器申请加入和退出组播组，默认情况下路由器是不会转发组播包到连接中的主机，除非主机通过 IGMP 加入到组播组，主机申请加入到组播组时，路由器就会记录 IGMP 路由器表，路由器后续就会转发组播包到对应的主机了。
- IGMP 报文采用 IP 封装，IP 头部的协议号为 2，而且 TTL 字段值通常为 1，因为 IGMP 是工作在主机与连接的路由器之间。

#### 3.6.1 工作机制

IGMP 分为了三个版本分别是，IGMPv1、IGMPv2、IGMPv3。，以 IGMPv2 作为例子，说说常规查询与响应和离开组播组这两个工作机制。

{{< tabs items="常规查询与响应工作机制,离开组播组工作机制" >}}
{{< tab >}}
{{< image "/images/docs/interview/network/常规查询与响应工作机制.webp" "常规查询与响应工作机制" >}}

- 路由器会周期性发送目的地址为 224.0.0.1（表示同一网段内所有主机和路由器） IGMP 常规查询报文。
- 主机 1 和 主机 3 收到这个查询，随后会启动「报告延迟计时器」，计时器的时间是随机的，通常是 0~10 秒，计时器超时后主机就会发送 IGMP 成员关系报告报文（源 IP 地址为自己主机的 IP 地址，目的 IP 地址为组播地址）。如果在定时器超时之前，收到同一个组内的其他主机发送的成员关系报告报文，则自己不再发送，这样可以减少网络中多余的 IGMP 报文数量。
- 路由器收到主机的成员关系报文后，就会在 IGMP 路由表中加入该组播组，后续网络中一旦该组播地址的数据到达路由器，它会把数据包转发出去。
  {{< /tab >}}

{{< tab >}}
<font style="color:orange;font-weight:bold;">离开组播组的情况一，网段中仍有该组播组：</font>
{{< image "/images/docs/interview/network/离开组播组工作机制.webp" "离开组播组工作机制" >}}

- 主机 1 要离开组 224.1.1.1，发送 IGMPv2 离组报文，报文的目的地址是 224.0.0.2（表示发向网段内的所有路由器）
- 路由器 收到该报文后，以 1 秒为间隔连续发送 IGMP 特定组查询报文（共计发送 2 个），以便确认该网络是否还有 224.1.1.1 组的其他成员。
- 主机 3 仍然是组 224.1.1.1 的成员，因此它立即响应这个特定组查询。路由器知道该网络中仍然存在该组播组的成员，于是继续向该网络转发 224.1.1.1 的组播数据包。

<font style="color:orange;font-weight:bold;">离开组播组的情况二，网段中没有该组播组：</font>
{{< image "/images/docs/interview/network/离开组播组工作机制2.webp" "离开组播组工作机制2" >}}

- 主机 1 要离开组播组 224.1.1.1，发送 IGMP 离组报文。
- 路由器收到该报文后，以 1 秒为间隔连续发送 IGMP 特定组查询报文（共计发送 2 个）。此时在该网段内，组 224.1.1.1 已经没有其他成员了，因此没有主机响应这个查询。
- 一定时间后，路由器认为该网段中已经没有 224.1.1.1 组播组成员了，将不会再向这个网段转发该组播地址的数据包。
  {{< /tab >}}
  {{< /tabs >}}

## 断网了，还能 ping 通 127.0.0.1 吗

### 127.0.0.1 和 localhost 以及 0.0.0.0 有区别吗

首先 localhost 就不叫 IP，它是一个域名，就跟 "baidu.com",是一个形式的东西，只不过默认会把它解析为 127.0.0.1 ，当然这可以在 /etc/hosts 文件下进行修改。

所以默认情况下，使用 localhost 跟使用 127.0.0.1 确实是没区别的。

其次就是 0.0.0.0，执行 ping 0.0.0.0 ，是会失败的，因为它在 IPV4 中表示的是无效的目标地址。

但它还是很有用处的，回想下，我们启动服务器的时候，一般会 listen 一个 IP 和端口，等待客户端的连接。

如果此时 listen 的是本机的 0.0.0.0 , 那么它表示本机上的所有 IPV4 地址。

```
/* Address to accept any incoming messages. */
#define    INADDR_ANY      ((unsigned long int) 0x00000000) /* 0.0.0.0   */
```

举个例子。刚刚提到的 127.0.0.1 和 192.168.31.6 ，都是本机的 IPV4 地址，如果监听 0.0.0.0 ，那么用上面两个地址，都能访问到这个服务器。

当然， 客户端 connect 时，不能使用 0.0.0.0 。必须指明要连接哪个服务器 IP。

### 总结

- 127.0.0.1 是回环地址。localhost 是域名，但默认等于 127.0.0.1。
- ping 回环地址和 ping 本机地址，是一样的，走的是 lo0 "假网卡"，都会经过网络层和数据链路层等逻辑，最后在快要出网卡前狠狠拐了个弯， 将数据插入到一个链表后就软中断通知 ksoftirqd 来进行收数据的逻辑，压根就不出网络。所以断网了也能 ping 通回环地址。
- 如果服务器 listen 的是 0.0.0.0，那么此时用 127.0.0.1 和本机地址都可以访问到服务。
